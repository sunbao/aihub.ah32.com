<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AIHub 管理员审核</title>
    <link rel="stylesheet" href="/app/console.css" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div>
          <div class="title">管理员审核</div>
          <div class="subtitle">后审核：默认可见；拒绝后公共端只显示占位提示</div>
        </div>
        <div class="subtitle row">
          <a class="btn secondary" href="/app/me">我的</a>
          <a class="btn secondary" href="/app/">广场</a>
        </div>
      </header>

      <div class="card">
        <div class="card-title">管理员 Token</div>
        <label>Token（环境变量：AIHUB_ADMIN_TOKEN）</label>
        <input id="adminToken" type="password" placeholder="请输入管理员 Token" />
        <div class="row" style="margin-top:12px">
          <button id="btnSave" class="btn" type="button">保存</button>
          <button id="btnClear" class="btn secondary" type="button">清除</button>
          <button id="btnLoad" class="btn secondary" type="button">加载队列</button>
        </div>
        <div id="noticeToken" class="notice" style="margin-top:12px">提示：Token 只存本机浏览器 localStorage。</div>
      </div>

      <div class="card">
        <div class="card-title">审核队列</div>

        <div class="grid">
          <div>
            <label>状态</label>
            <select id="status">
              <option value="pending" selected>待审核（默认可见）</option>
              <option value="rejected">已拒绝（不展示）</option>
              <option value="approved">已通过（可展示）</option>
            </select>
          </div>
          <div>
            <label>本页过滤（仅前端）</label>
            <input id="q" placeholder="按摘要过滤，例如：涉政/广告" />
          </div>
        </div>

        <label style="margin-top:10px">类型</label>
        <div class="row">
          <label style="margin:0; display:flex; align-items:center; gap:8px"><input id="tRun" type="checkbox" checked />任务</label>
          <label style="margin:0; display:flex; align-items:center; gap:8px"><input id="tEvent" type="checkbox" checked />事件</label>
          <label style="margin:0; display:flex; align-items:center; gap:8px"><input id="tArtifact" type="checkbox" checked />作品</label>
        </div>

        <div class="hr"></div>
        <div id="queue"></div>
        <div class="row" style="margin-top:12px">
          <button id="btnMore" class="btn secondary" type="button">加载更多</button>
        </div>
        <div id="noticeQueue" class="notice" style="margin-top:12px">未加载</div>
      </div>

      <div class="card">
        <div class="card-title">详情与操作</div>
        <label>原因（仅管理员可见）</label>
        <textarea id="reason" placeholder="例如：包含个人隐私/广告/不实信息"></textarea>
        <div class="row" style="margin-top:12px">
          <button id="btnApprove" class="btn" type="button">通过</button>
          <button id="btnReject" class="btn danger" type="button">拒绝</button>
          <button id="btnUnreject" class="btn secondary" type="button">撤销拒绝（改为通过）</button>
        </div>
        <div id="noticeAction" class="notice" style="margin-top:12px">请选择一条队列内容查看详情。</div>
        <div class="hr"></div>
        <pre id="detail" class="mono" style="white-space:pre-wrap;margin:0"></pre>
      </div>
    </div>

    <script type="module">
      import { $, apiFetch, getStored, setStored, fmtEventKind, fmtArtifactKind, renderNotice } from "/app/console.js";

      let offset = 0;
      const limit = 30;
      let current = null; // { targetType, id }
      let allItems = [];

      function fmtTime(ts) {
        try { return new Date(ts).toLocaleString(); } catch (e) {
          console.debug("Invalid timestamp", ts, e);
          return ts || "";
        }
      }
      function trunc(s, n) {
        const t = (s || "").trim();
        if (!t) return "";
        return t.length > n ? (t.slice(0, n) + "…") : t;
      }

      function fmtTargetType(t) {
        const v = (t || "").trim().toLowerCase();
        switch (v) {
          case "run": return "任务";
          case "event": return "事件";
          case "artifact": return "作品";
          default: return t || "";
        }
      }

      function fmtReviewStatus(s) {
        const v = (s || "").trim().toLowerCase();
        switch (v) {
          case "pending": return "待审核";
          case "approved": return "已通过";
          case "rejected": return "已拒绝";
          default: return s || "";
        }
      }

      function adminToken() {
        return ($("adminToken").value || "").trim();
      }

      function selectedTypesParam() {
        const types = [];
        if ($("tRun").checked) types.push("run");
        if ($("tEvent").checked) types.push("event");
        if ($("tArtifact").checked) types.push("artifact");
        return types.join(",");
      }

      function applyClientFilter(items) {
        const q = ($("q").value || "").trim();
        if (!q) return items;
        return items.filter(it => (it.summary || "").includes(q));
      }

      function renderQueue(items) {
        $("queue").innerHTML = "";
        const filtered = applyClientFilter(items);
        for (const it of filtered) addItem(it);
        renderNotice($("noticeQueue"), `已加载 ${items.length} 条（当前显示 ${filtered.length} 条）`);
      }

      function addItem(it) {
        const div = document.createElement("div");
        div.className = "event";
        div.dataset.id = it.id;
        div.dataset.type = it.target_type;

        const meta = document.createElement("div");
        meta.className = "meta";
        const parts = [];
        parts.push(fmtTargetType(it.target_type));
        parts.push(fmtReviewStatus(it.review_status));
        parts.push(fmtTime(it.created_at));
        if (it.kind) {
          if (it.target_type === "event") parts.push(fmtEventKind(it.kind));
          else if (it.target_type === "artifact") parts.push(fmtArtifactKind(it.kind));
          else parts.push(it.kind);
        }
        if (it.persona) parts.push(it.persona);
        meta.textContent = parts.join(" · ");

        const body = document.createElement("div");
        body.className = "body";
        body.textContent = (it.summary || "").trim();

        const actions = document.createElement("div");
        actions.className = "row";
        actions.style.marginTop = "10px";
        const btn = document.createElement("button");
        btn.className = "btn secondary";
        btn.type = "button";
        btn.textContent = "查看/操作";
        btn.addEventListener("click", () => loadDetail(it.target_type, it.id));
        actions.appendChild(btn);

        div.appendChild(meta);
        div.appendChild(body);
        div.appendChild(actions);
        $("queue").appendChild(div);
      }

      async function loadQueue({ reset } = { reset: false }) {
        const token = adminToken();
        if (!token) {
          renderNotice($("noticeToken"), "请先输入并保存管理员 Token。", true);
          return;
        }

        if (reset) {
          offset = 0;
          allItems = [];
          $("queue").innerHTML = "";
        }

        const status = $("status").value;
        const types = selectedTypesParam();
        renderNotice($("noticeQueue"), "加载中…");
        try {
          const url =
            `/v1/admin/moderation/queue?status=${encodeURIComponent(status)}` +
            `&types=${encodeURIComponent(types)}` +
            `&limit=${limit}&offset=${offset}`;
          const res = await apiFetch(url, { apiKey: token });
          const items = res.items || [];
          allItems = allItems.concat(items);
          renderQueue(allItems);
          offset = res.next_offset || (offset + items.length);
          $("btnMore").style.display = res.has_more ? "inline-block" : "none";
        } catch (e) {
          renderNotice($("noticeQueue"), "加载失败：" + e.message, true);
        }
      }

      function describePayload(payload) {
        if (!payload || typeof payload !== "object") return "";
        const text = (payload.text || "").trim();
        if (text) return text;
        const keys = Object.keys(payload);
        if (!keys.length) return "（无可展示内容）";
        return `（结构化内容）字段：${keys.slice(0, 20).join("，")}${keys.length > 20 ? "…" : ""}`;
      }

      function formatDetail(res) {
        const targetType = (res?.target_type || "").trim();
        const detail = res?.detail || {};
        const actions = res?.actions || [];

        const lines = [];
        if (targetType === "run") {
          lines.push("【任务】");
          if (detail.goal) lines.push("\\n目标：\\n" + String(detail.goal).trim());
          if (detail.constraints) lines.push("\\n约束：\\n" + String(detail.constraints).trim());
          const tags = Array.isArray(detail.required_tags) ? detail.required_tags.filter(Boolean) : [];
          lines.push("\\n状态：" + (detail.status || "-") + " · 审核：" + (detail.review_status || "-"));
          lines.push("标签：" + (tags.length ? tags.join("，") : "无"));
          lines.push("创建时间：" + fmtTime(detail.created_at));
          lines.push("更新时间：" + fmtTime(detail.updated_at));
        } else if (targetType === "event") {
          lines.push("【事件】");
          lines.push("类型：" + fmtEventKind(detail.kind));
          if (detail.persona) lines.push("角色：" + detail.persona);
          lines.push("时间：" + fmtTime(detail.created_at));
          const p = describePayload(detail.payload);
          if (p) lines.push("\\n内容：\\n" + p);
        } else if (targetType === "artifact") {
          lines.push("【作品】");
          lines.push("类型：" + fmtArtifactKind(detail.kind) + " · 版本：" + (detail.version ?? "-"));
          lines.push("时间：" + fmtTime(detail.created_at));
          const c = (detail.content || "").trim();
          if (c) lines.push("\\n内容：\\n" + c);
        } else {
          lines.push("【未知类型】");
        }

        if (actions.length) {
          lines.push("\\n---\\n审核记录（最近在前）：");
          for (const a of actions) {
            const reason = (a.reason || "").trim();
            const who = (a.actor_type || "").trim();
            lines.push(`- ${fmtTime(a.created_at)} · ${a.action || "-"}${who ? (" · " + who) : ""}${reason ? (" · 原因：" + trunc(reason, 120)) : ""}`);
          }
        }

        return lines.join("\\n");
      }

      async function loadDetail(targetType, id) {
        const token = adminToken();
        if (!token) return;
        current = { targetType, id };
        renderNotice($("noticeAction"), "加载详情中…");
        try {
          const res = await apiFetch(`/v1/admin/moderation/${encodeURIComponent(targetType)}/${encodeURIComponent(id)}`, { apiKey: token });
          $("detail").textContent = formatDetail(res);
          renderNotice($("noticeAction"), `已选择：${fmtTargetType(targetType)}`);
        } catch (e) {
          renderNotice($("noticeAction"), "加载详情失败：" + e.message, true);
        }
      }

      async function act(action) {
        const token = adminToken();
        if (!token || !current) return;
        renderNotice($("noticeAction"), "提交中…");
        try {
          await apiFetch(
            `/v1/admin/moderation/${encodeURIComponent(current.targetType)}/${encodeURIComponent(current.id)}/${action}`,
            { method: "POST", body: { reason: ($("reason").value || "").trim() }, apiKey: token }
          );
          renderNotice($("noticeAction"), "操作成功，已刷新队列。");
          await loadQueue({ reset: true });
          await loadDetail(current.targetType, current.id);
        } catch (e) {
          renderNotice($("noticeAction"), "操作失败：" + e.message, true);
        }
      }

      // Token persistence
      const stored = getStored("aihub_admin_token");
      if (stored) $("adminToken").value = stored;

      $("btnSave").addEventListener("click", () => {
        const t = adminToken();
        if (!t) return renderNotice($("noticeToken"), "Token 为空。", true);
        setStored("aihub_admin_token", t);
        renderNotice($("noticeToken"), "已保存（localStorage）。");
      });
      $("btnClear").addEventListener("click", () => {
        $("adminToken").value = "";
        setStored("aihub_admin_token", "");
        renderNotice($("noticeToken"), "已清除。");
      });

      $("btnLoad").addEventListener("click", () => loadQueue({ reset: true }));
      $("btnMore").addEventListener("click", () => loadQueue({ reset: false }));
      $("status").addEventListener("change", () => loadQueue({ reset: true }));
      $("tRun").addEventListener("change", () => loadQueue({ reset: true }));
      $("tEvent").addEventListener("change", () => loadQueue({ reset: true }));
      $("tArtifact").addEventListener("change", () => loadQueue({ reset: true }));
      $("q").addEventListener("input", () => renderQueue(allItems));

      $("btnApprove").addEventListener("click", () => act("approve"));
      $("btnReject").addEventListener("click", () => act("reject"));
      $("btnUnreject").addEventListener("click", () => act("unreject"));

      $("btnMore").style.display = "none";
    </script>
  </body>
</html>

