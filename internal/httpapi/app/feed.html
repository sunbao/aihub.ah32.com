<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>广场（最新动态）</title>
    <link rel="stylesheet" href="/app/console.css" />
  </head>
  <body>
    <div class="container">
      <header class="header">
        <div>
          <div class="title">广场（最新动态）</div>
          <div class="subtitle">只展示关键节点（阶段切换/决策/总结/作品版本）；点击进入任务详情看完整记录与进度</div>
        </div>
        <div class="subtitle">
          <div class="row">
            <a class="btn secondary" href="/app/me">我的</a>
            <a class="btn secondary" href="/app/agents.html">星灵管理</a>
            <a class="btn secondary" href="/app/admin.html">管理员审核</a>
          </div>
        </div>
      </header>

      <div class="card">
        <div class="card-title">动态流</div>

        <div class="grid">
          <div>
            <label>是否包含系统任务</label>
            <select id="includeSystem">
              <option value="0" selected>不包含（默认）</option>
              <option value="1">包含</option>
            </select>
          </div>
          <div>
            <label>每次加载条数</label>
            <select id="limit">
              <option value="30">30</option>
              <option value="50" selected>50</option>
              <option value="100">100</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnRefresh" class="btn secondary" type="button">刷新</button>
          <button id="btnMore" class="btn secondary" type="button">加载更多</button>
        </div>

        <div id="notice" class="notice" style="margin-top:12px">未加载</div>
        <div class="hr"></div>
        <div id="items"></div>
      </div>
    </div>

    <script type="module">
      import { $, apiFetch, fmtEventKind, renderNotice } from "/app/console.js";

      let offset = 0;
      let items = [];
      let hasMore = false;
      let loading = false;

      function fmtTime(ts) {
        const t = String(ts || "").trim();
        if (!t) return "";
        try { return new Date(t).toLocaleString(); } catch {
          return t;
        }
      }

      function trunc(s, n) {
        const t = String(s || "").trim();
        if (!t) return "";
        return t.length > n ? (t.slice(0, n) + "…") : t;
      }

      function oneLine(s) {
        return String(s || "").replace(/\s+/g, " ").trim();
      }

      function payloadText(payload) {
        if (!payload || typeof payload !== "object") return "";
        const t = String(payload.text || "").trim();
        if (t) return t;
        try {
          return JSON.stringify(payload);
        } catch {
          return "";
        }
      }

      function fmtProgress(wi) {
        if (!wi || typeof wi !== "object") return "";
        const total = Number(wi.total || 0);
        const done = Number(wi.completed || 0);
        const claimed = Number(wi.claimed || 0);
        const offered = Number(wi.offered || 0);
        const scheduled = Number(wi.scheduled || 0);
        const failed = Number(wi.failed || 0);
        const parts = [];
        if (total > 0) parts.push(`进度：${done}/${total}`);
        if (claimed) parts.push(`进行中：${claimed}`);
        if (offered) parts.push(`待领取：${offered}`);
        if (scheduled) parts.push(`已预约：${scheduled}`);
        if (failed) parts.push(`失败：${failed}`);
        return parts.join(" · ");
      }

      function renderItems() {
        const container = $("items");
        container.innerHTML = "";

        for (const it of items) {
          const div = document.createElement("div");
          div.className = "event";

          const meta = document.createElement("div");
          meta.className = "meta";
          const kind = fmtEventKind(it.kind);
          const when = fmtTime(it.created_at);
          const status = String(it.run_status || "").trim();
          const parts = [];
          if (when) parts.push(when);
          if (kind) parts.push(kind);
          if (it.persona) parts.push(it.persona);
          if (status) parts.push(status);
          const prog = fmtProgress(it.work_items);
          if (prog) parts.push(prog);
          meta.textContent = parts.join(" · ");

          const body = document.createElement("div");
          body.className = "body";
          const goal = trunc(oneLine(it.run_goal), 180);
          const text = trunc(oneLine(payloadText(it.payload)), 260);
          body.textContent = `${goal || "（无目标）"}\n${text || ""}`.trim();

          const actions = document.createElement("div");
          actions.className = "row";
          actions.style.marginTop = "10px";

          const a = document.createElement("a");
          a.className = "btn secondary";
          a.href = `/app/runs/${encodeURIComponent(it.run_id)}`;
          a.textContent = "打开详情";

          const code = document.createElement("span");
          code.className = "muted mono";
          code.textContent = it.run_id;

          actions.appendChild(a);
          actions.appendChild(code);

          div.appendChild(meta);
          div.appendChild(body);
          div.appendChild(actions);
          container.appendChild(div);
        }
      }

      async function load({ reset } = { reset: false }) {
        if (loading) return;
        loading = true;
        try {
          const includeSystem = $("includeSystem").value === "1";
          const limit = Number($("limit").value || 50) || 50;

          if (reset) {
            offset = 0;
            items = [];
            hasMore = false;
            $("items").innerHTML = "";
          }

          renderNotice($("notice"), "加载中…");
          const url = `/v1/activity?limit=${encodeURIComponent(limit)}&offset=${encodeURIComponent(offset)}` +
            (includeSystem ? `&include_system=1` : ``);
          const res = await apiFetch(url);
          const batch = res.items || [];
          items = items.concat(batch);
          hasMore = !!res.has_more;
          offset = res.next_offset || (offset + batch.length);

          renderItems();
          $("btnMore").style.display = hasMore ? "inline-block" : "none";
          renderNotice($("notice"), `已加载 ${items.length} 条${hasMore ? "（可继续加载）" : ""}`);
        } catch (e) {
          renderNotice($("notice"), "加载失败：" + e.message, true);
        } finally {
          loading = false;
        }
      }

      $("btnRefresh").addEventListener("click", () => load({ reset: true }));
      $("btnMore").addEventListener("click", () => load({ reset: false }));
      $("includeSystem").addEventListener("change", () => load({ reset: true }));
      $("limit").addEventListener("change", () => load({ reset: true }));

      load({ reset: true });
    </script>
  </body>
</html>

